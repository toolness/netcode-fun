(this["webpackJsonpnetcode-fun"]=this["webpackJsonpnetcode-fun"]||[]).push([[0],[,,,,,,,,,function(e,t,n){e.exports=n(17)},,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),i=n(6),o=n.n(i),c=(n(14),n(1)),s=(n(15),n(7)),u=n(3),l=n(4),m=n(2),f=(n(16),{x:0,y:0});function h(e,t){return{x:e.x+t.x,y:e.y+t.y}}function p(e,t){return{x:t*e.x,y:t*e.y}}var y=n(8);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(n,!0).forEach((function(t){Object(m.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var b=function(e){var t=e.width,n=e.height,r=e.style,i=Object(y.a)(e,["width","height","style"]);return a.a.createElement("div",Object.assign({style:v({},r,{height:0,paddingTop:"".concat(n/t*100,"%")})},i))};function O(e,t){var n=[],r=!1;return e.forEach((function(e){var a=t(e);a===e||r||(r=!0),n.push(a)})),r?n:e}function w(e,t,n){if(t<0||t>=e.length)throw new Error("Array index ".concat(t," is out of bounds"));var r=e.slice();return r.splice(t,1,n),r}function E(e,t,n){return e<t?t:e>n?n:e}function j(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?j(n,!0).forEach((function(t){Object(m.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):j(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return g({},e,{players:O(e.players,(function(n){return function(e,t,n){if(r=e.velocity,a=f,r.x===a.x&&r.y===a.y)return e;for(var r,a,i=g({},e),o=0;o<n;o++)i.position=h(i.position,e.velocity);return i.position.x=E(i.position.x,0,t.size.x-e.size.x),i.position.y=E(i.position.y,0,t.size.y-e.size.y),i}(n,e,t)})),time:e.time+t})}var x={inputTickDelay:0,historyLength:1e3},P=g({},x,{networkTickDelay:1}),S=function(){function e(t,n){Object(u.a)(this,e),this.runners=[],this.options=void 0,this.inTransitCommands=[],this.options=g({},P,{},n);for(var r=0;r<t.players.length;r++)this.runners.push(new D(t,n))}return Object(l.a)(e,[{key:"setInputTickDelay",value:function(e){this.runners.forEach((function(t){t.options.inputTickDelay=e}))}},{key:"setNetworkTickDelay",value:function(e){this.options.networkTickDelay=e}},{key:"tick",value:function(){var e=this;this.inTransitCommands=this.inTransitCommands.filter((function(t){return 0===t.ticksLeft?(e.runners.forEach((function(e,n){n!==t.command.playerIndex&&e.queuedCommands.push(t.command)})),!1):(t.ticksLeft--,!0)})),this.runners.forEach((function(e){return e.tick()}))}},{key:"setPlayerVelocity",value:function(e,t){var n=this.runners[e].setPlayerVelocity(e,t);this.inTransitCommands.push({ticksLeft:this.options.networkTickDelay,command:n})}}]),e}();function C(e){var t=e.state;return e.commands.forEach((function(e){t=function(e,t){if(t.time!==e.time)throw new Error("We can only apply commands made at the same time as the sim right now");switch(t.type){case"set-velocity":return g({},e,{players:w(e.players,t.playerIndex,g({},e.players[t.playerIndex],{velocity:t.velocity}))})}}(t,e)})),t=k(t,1)}var D=function(){function e(t,n){Object(u.a)(this,e),this.initialState=t,this.currentState=void 0,this.history=[],this.options=void 0,this.queuedCommands=[],this.options=g({},x,{},n),this.currentState=t}return Object(l.a)(e,[{key:"addToHistory",value:function(e){this.history.push(e);var t=this.history.length-this.options.historyLength;return t>0&&this.history.splice(0,t),e}},{key:"getHistoryIndexForTime",value:function(e){var t=this.currentState.time,n=this.history.length-(t-e);if(n<0)throw new Error("History is not long enough for time ".concat(e,"!"));if(n>=this.history.length)throw new Error("Time ".concat(e," is in the present or future, not the past!"));return n}},{key:"rollbackAndApplyCommands",value:function(e){var t,n=e[0].time,r=this.getHistoryIndexForTime(n);(t=this.history[r].commands).push.apply(t,Object(s.a)(e));for(var a=r;a<this.history.length;a++){var i=C(this.history[a]),o=a+1;o<this.history.length?this.history[o].state=i:this.currentState=i}}},{key:"getStateAtTime",value:function(e){return e===this.currentState.time?this.currentState:this.history[this.getHistoryIndexForTime(e)].state}},{key:"tick",value:function(){var e=this,t=function(e,t){var n=[],r=[],a=[];return e.forEach((function(e){e.time<t?n.push(e):e.time>t?a.push(e):r.push(e)})),[n,r,a]}(this.queuedCommands,this.currentState.time),n=Object(c.a)(t,3),r=n[0],a=n[1],i=n[2];this.queuedCommands=i,function(e){for(var t=[],n=function(){var n=e[0].time,r=function(e,t){var n=[],r=[];return e.forEach((function(e){t(e)?n.push(e):r.push(e)})),[n,r]}(e,(function(e){return e.time===n})),a=Object(c.a)(r,2),i=a[0],o=a[1];t.push(i),e=o};e.length>0;)n();return t}(r).forEach((function(t){return e.rollbackAndApplyCommands(t)})),this.currentState=C(this.addToHistory({state:this.currentState,commands:a}))}},{key:"setPlayerVelocity",value:function(e,t){var n={type:"set-velocity",time:this.currentState.time+this.options.inputTickDelay,playerIndex:e,velocity:t};return this.queuedCommands.push(n),n}}]),e}(),T=function(e){var t=e.player,n=e.sim;return a.a.createElement("div",{className:"Player-viz Player-number-".concat(t.number),title:"Player ".concat(t.number),style:{width:"".concat(t.size.x/n.size.x*100,"%"),top:"".concat(t.position.y/n.size.y*100,"%"),left:"".concat(t.position.x/n.size.x*100,"%")}},a.a.createElement(b,{width:t.size.x,height:t.size.y}))},z=function(e){var t=e.sim;return a.a.createElement(b,{className:"Sim-viz",width:t.size.x,height:t.size.y},t.players.map((function(e){return a.a.createElement(T,{key:e.number,player:e,sim:t})})))};function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var N=a.a.createContext({}),A=function(e){var t=Object(r.useState)({}),n=Object(c.a)(t,2),i=n[0],o=n[1];return Object(r.useEffect)((function(){var e=function(e){if(!document.activeElement||"INPUT"!==document.activeElement.nodeName){var t="keydown"===e.type;o((function(n){return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(n,!0).forEach((function(t){Object(m.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},n,Object(m.a)({},e.key.toLowerCase(),t))}))}};return window.addEventListener("keydown",e,!0),window.addEventListener("keyup",e,!0),function(){window.removeEventListener("keydown",e,!0),window.removeEventListener("keyup",e,!0)}}),[]),a.a.createElement(N.Provider,Object.assign({value:i},e))};var F=function(e){var t=e.button,n=Object(r.useContext)(N)[t]?1:.66;return a.a.createElement("kbd",{style:{opacity:n}},function(e){switch(e){case"arrowup":return"\u2191";case"arrowdown":return"\u2193";case"arrowleft":return"\u2190";case"arrowright":return"\u2192"}return e.toUpperCase()}(t))};function L(e,t){return e&&t?0:e||t?e?1:-1:0}function H(e,t){var n=Object(r.useContext)(N),a=n[e],i=n[t],o=Object(r.useState)(L(!!a,!!i)),s=Object(c.a)(o,2),u=s[0],l=s[1],m=function(e){var t=Object(r.useRef)(void 0);return Object(r.useEffect)((function(){t.current=e})),t.current}(u);return Object(r.useEffect)((function(){return l(L(!!a,!!i))}),[a,i]),[u,m]}var q=function(e){var t=e.onChange,n=H(e.right,e.left),i=Object(c.a)(n,2),o=i[0],s=i[1],u=H(e.down,e.up),l=Object(c.a)(u,2),m=l[0],f=l[1];return Object(r.useEffect)((function(){m===f&&o===s||t({x:o,y:m})}),[o,s,m,f,t]),a.a.createElement("div",null,a.a.createElement("div",null,a.a.createElement(F,{button:e.up})),a.a.createElement("div",null,a.a.createElement(F,{button:e.left}),a.a.createElement(F,{button:e.down}),a.a.createElement(F,{button:e.right})))};var V,R,W={x:5,y:5},B={x:100,y:100},J={players:[{number:1,position:f,velocity:f,size:W},{number:2,position:(V=B,R=W,h(V,p(R,-1))),velocity:f,size:W}],size:B,time:0};function U(e){13!==e.keyCode&&27!==e.keyCode||(e.preventDefault(),document.documentElement.focus())}var G=function(e){return a.a.createElement(a.a.Fragment,null,a.a.createElement("label",{htmlFor:e.id},e.label,":")," ",a.a.createElement("input",{type:"number",value:e.value,min:e.min,max:e.max,onChange:function(t){return e.onChange(function(e,t,n,r){var a=parseInt(e);return isNaN(a)?r:E(a,t,n)}(t.target.value,e.min,e.max,e.value))},onKeyDown:U}))},K=function(){var e=Object(r.useState)(10),t=Object(c.a)(e,2),n=t[0],i=t[1],o=Object(r.useState)(3),s=Object(c.a)(o,2),u=s[0],l=s[1],m=Object(r.useState)(2),f=Object(c.a)(m,2),h=f[0],y=f[1],d=Object(r.useState)(60),v=Object(c.a)(d,2),b=v[0],O=v[1],w=Object(r.useRef)(new S(J,{inputTickDelay:u,networkTickDelay:h})).current,E=Object(r.useState)(w.runners[0].currentState),j=Object(c.a)(E,2),g=j[0],k=j[1],x=Object(r.useState)(w.runners[1].currentState),P=Object(c.a)(x,2),C=P[0],D=P[1],T=1e3/b,I=Object(r.useCallback)((function(e){return w.setPlayerVelocity(0,p(e,.1*n))}),[w,n]),N=Object(r.useCallback)((function(e){return w.setPlayerVelocity(1,p(e,.1*n))}),[w,n]),F=Object(r.useCallback)((function(){w.tick(),k(w.runners[0].currentState),D(w.runners[1].currentState)}),[w]);return Object(r.useEffect)((function(){return w.setInputTickDelay(u)}),[u,w]),Object(r.useEffect)((function(){return w.setNetworkTickDelay(h)}),[h,w]),function(e,t){var n=Object(r.useRef)(-1);Object(r.useEffect)((function(){return n.current=window.setInterval(e,t),function(){window.clearInterval(n.current)}}),[e,t])}(F,T),a.a.createElement(A,null,a.a.createElement("div",{className:"App"},a.a.createElement("div",{className:"App-viewports"},a.a.createElement("div",null,a.a.createElement("h2",null,"Player 1"),a.a.createElement(z,{sim:g}),a.a.createElement(q,{up:"w",down:"s",left:"a",right:"d",onChange:I})),a.a.createElement("div",null,a.a.createElement("h2",null,"Configuration"),a.a.createElement("p",null,a.a.createElement(G,{id:"fps",label:"Simulation FPS",min:1,max:60,value:b,onChange:O}),a.a.createElement("span",{className:"App-desc"},T.toFixed(0),"ms between frames")),a.a.createElement("p",null,a.a.createElement(G,{id:"itd",label:"Input frame delay",min:0,max:100,value:u,onChange:l}),a.a.createElement("span",{className:"App-desc"},(T*u).toFixed(0),"ms before input affects simulation")),a.a.createElement("p",null,a.a.createElement(G,{id:"ntd",label:"Network frame delay",min:0,max:100,value:h,onChange:y}),a.a.createElement("span",{className:"App-desc"},(T*h).toFixed(0),"ms of simulated network lag")),a.a.createElement("p",null,a.a.createElement(G,{id:"speed",label:"Player speed",min:1,max:100,value:n,onChange:i})),a.a.createElement("p",{className:"App-desc"},"This is an exploration of delay and rollback-based netcode in a simulated network environment. For more details, please see the ",a.a.createElement("a",{href:"https://github.com/toolness/netcode-fun#readme",target:"_blank",rel:"noopener noreferrer"},"GitHub README"),".")),a.a.createElement("div",null,a.a.createElement("h2",null,"Player 2"),a.a.createElement(z,{sim:C}),a.a.createElement(q,{up:"arrowup",down:"arrowdown",left:"arrowleft",right:"arrowright",onChange:N})))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(K,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}],[[9,1,2]]]);
//# sourceMappingURL=main.27cb48bf.chunk.js.map