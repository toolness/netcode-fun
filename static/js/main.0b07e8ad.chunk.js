(this["webpackJsonpnetcode-fun"]=this["webpackJsonpnetcode-fun"]||[]).push([[0],[,,,,,,,,,,,,,,,function(e,t,n){e.exports=n(25)},,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var i=n(0),r=n.n(i),a=n(9),o=n.n(a),s=(n(20),n(21),n(6)),c=n(2),u=n(1),l=r.a.createContext({buttons:{},setButton:function(){}}),m=function(e){var t=Object(i.useState)({}),n=Object(u.a)(t,2),a=n[0],o=n[1],m=function(e,t){o((function(n){return Object(c.a)({},n,Object(s.a)({},e,t))}))};return Object(i.useEffect)((function(){var e=function(e){if(!document.activeElement||"INPUT"!==document.activeElement.nodeName){var t="keydown"===e.type;m(e.key.toLowerCase(),t)}};return window.addEventListener("keydown",e,!0),window.addEventListener("keyup",e,!0),function(){window.removeEventListener("keydown",e,!0),window.removeEventListener("keyup",e,!0)}}),[]),r.a.createElement(l.Provider,Object.assign({value:{buttons:a,setButton:m}},e))};n(22);var h=n(11),d=n(3),f=n(4),p={x:0,y:0};function y(e,t){return{x:e.x+t.x,y:e.y+t.y}}function v(e,t){return{x:t*e.x,y:t*e.y}}function b(e,t){var n=[],i=!1;return e.forEach((function(e){var r=t(e);r===e||i||(i=!0),n.push(r)})),i?n:e}function w(e,t,n){if(t<0||t>=e.length)throw new Error("Array index ".concat(t," is out of bounds"));var i=e.slice();return i.splice(t,1,n),i}function g(e,t,n){return e<t?t:e>n?n:e}function E(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return Object(c.a)({},e,{players:b(e.players,(function(n){return function(e,t,n){if(i=e.velocity,r=p,i.x===r.x&&i.y===r.y)return e;for(var i,r,a=Object(c.a)({},e),o=0;o<n;o++)a.position=y(a.position,e.velocity);return a.position.x=g(a.position.x,0,t.size.x-e.size.x),a.position.y=g(a.position.y,0,t.size.y-e.size.y),a}(n,e,t)})),time:e.time+t})}var O={inputTickDelay:0,historyLength:1e3},T=Object(c.a)({},O,{networkTickDelay:1}),k=function(){function e(t,n){Object(d.a)(this,e),this.runners=[],this.options=void 0,this.inTransitCommands=[],this.options=Object(c.a)({},T,{},n);for(var i=0;i<t.players.length;i++)this.runners.push(new S(t,n))}return Object(f.a)(e,[{key:"setInputTickDelay",value:function(e){this.runners.forEach((function(t){t.options.inputTickDelay=e}))}},{key:"setNetworkTickDelay",value:function(e){this.options.networkTickDelay=e}},{key:"tick",value:function(){var e=this;this.inTransitCommands=this.inTransitCommands.filter((function(t){return 0===t.ticksLeft?(e.runners.forEach((function(e,n){n!==t.command.playerIndex&&e.queuedCommands.push(t.command)})),!1):(t.ticksLeft--,!0)})),this.runners.forEach((function(e){return e.tick()}))}},{key:"setPlayerVelocity",value:function(e,t){var n=this.runners[e].setPlayerVelocity(e,t);this.inTransitCommands.push({ticksLeft:this.options.networkTickDelay,command:n})}}]),e}();function j(e){var t=e.state;return e.commands.forEach((function(e){t=function(e,t){if(t.time!==e.time)throw new Error("We can only apply commands made at the same time as the sim right now");switch(t.type){case"set-velocity":return Object(c.a)({},e,{players:w(e.players,t.playerIndex,Object(c.a)({},e.players[t.playerIndex],{velocity:t.velocity}))})}}(t,e)})),t=E(t,1)}var S=function(){function e(t,n){Object(d.a)(this,e),this.initialState=t,this.currentState=void 0,this.history=[],this.options=void 0,this.queuedCommands=[],this.options=Object(c.a)({},O,{},n),this.currentState=t}return Object(f.a)(e,[{key:"serialize",value:function(){for(var e=this.currentState.time-this.history.length,t=this.getStateAtTime(e),n=[],i=0;i<this.history.length;i++)n.push.apply(n,this.history[i].commands);return n.push.apply(n,this.queuedCommands),{initialState:t,commands:n,currentTime:this.currentState.time,options:this.options}}},{key:"addToHistory",value:function(e){this.history.push(e);var t=this.history.length-this.options.historyLength;return t>0&&this.history.splice(0,t),e}},{key:"getHistoryIndexForTime",value:function(e){var t=this.currentState.time,n=this.history.length-(t-e);if(n<0)throw new Error("History is not long enough for time ".concat(e,"!"));if(n>=this.history.length)throw new Error("Time ".concat(e," is in the present or future, not the past!"));return n}},{key:"rollbackAndApplyCommands",value:function(e){var t,n=e[0].time,i=this.getHistoryIndexForTime(n);(t=this.history[i].commands).push.apply(t,Object(h.a)(e));for(var r=i;r<this.history.length;r++){var a=j(this.history[r]),o=r+1;o<this.history.length?this.history[o].state=a:this.currentState=a}}},{key:"getStateAtTime",value:function(e){return e===this.currentState.time?this.currentState:this.history[this.getHistoryIndexForTime(e)].state}},{key:"tick",value:function(){var e=this,t=function(e,t){var n=[],i=[],r=[];return e.forEach((function(e){e.time<t?n.push(e):e.time>t?r.push(e):i.push(e)})),[n,i,r]}(this.queuedCommands,this.currentState.time),n=Object(u.a)(t,3),i=n[0],r=n[1],a=n[2];this.queuedCommands=a,function(e){for(var t=[],n=function(){var n=e[0].time,i=function(e,t){var n=[],i=[];return e.forEach((function(e){t(e)?n.push(e):i.push(e)})),[n,i]}(e,(function(e){return e.time===n})),r=Object(u.a)(i,2),a=r[0],o=r[1];t.push(a),e=o};e.length>0;)n();return t}(i).forEach((function(t){return e.rollbackAndApplyCommands(t)})),this.currentState=j(this.addToHistory({state:this.currentState,commands:r}))}},{key:"setPlayerVelocity",value:function(e,t){var n={type:"set-velocity",time:this.currentState.time+this.options.inputTickDelay,playerIndex:e,velocity:t};return this.queuedCommands.push(n),n}}],[{key:"deserialize",value:function(t){var n=new e(t.initialState,t.options);if(n.queuedCommands.push.apply(n.queuedCommands,t.commands),t.currentTime<n.currentState.time)throw new Error("Current time is before initial state time!");for(;n.currentState.time!==t.currentTime;)n.tick();return n}}]),e}(),x=function(e){var t=e.button,n=Object(i.useContext)(l),a=n.buttons[t]?1:.66,o=function(e,i){i.preventDefault(),n.setButton(t,e)},s=o.bind(null,!0),c=o.bind(null,!1);return r.a.createElement("kbd",{style:{opacity:a,cursor:"pointer"},onMouseDown:s,onMouseUp:c,onTouchStart:s,onTouchEnd:c},function(e){switch(e){case"arrowup":return"\u2191";case"arrowdown":return"\u2193";case"arrowleft":return"\u2190";case"arrowright":return"\u2192"}return e.toUpperCase()}(t))};function C(e,t){return e&&t?0:e||t?e?1:-1:0}function P(e,t){var n=Object(i.useContext)(l).buttons,r=n[e],a=n[t],o=Object(i.useState)(C(!!r,!!a)),s=Object(u.a)(o,2),c=s[0],m=s[1],h=function(e){var t=Object(i.useRef)(void 0);return Object(i.useEffect)((function(){t.current=e})),t.current}(c);return Object(i.useEffect)((function(){return m(C(!!r,!!a))}),[r,a]),[c,h]}var D=function(e){var t=e.onChange,n=P(e.right,e.left),a=Object(u.a)(n,2),o=a[0],s=a[1],c=P(e.down,e.up),l=Object(u.a)(c,2),m=l[0],h=l[1];return Object(i.useEffect)((function(){m===h&&o===s||t({x:o,y:m})}),[o,s,m,h,t]),r.a.createElement("div",null,r.a.createElement("div",null,r.a.createElement(x,{button:e.up})),r.a.createElement("div",null,r.a.createElement(x,{button:e.left}),r.a.createElement(x,{button:e.down}),r.a.createElement(x,{button:e.right})))},N=function(){function e(t,n,i,r){var a;Object(d.a)(this,e),this.fps=t,this.callback=n,this.now=i,this.syncWithStartTime=r,this.idealDelta=void 0,this._frame=void 0,this.totalDelta=void 0,this.start=void 0,this.timeout=void 0,this.isStopped=!1;var o=i(),s=o-(null!==(a=r)&&void 0!==a?a:o);this.idealDelta=1e3/t;var c=Math.abs(s%this.idealDelta),u=this.idealDelta-c;this.start=o-c,this._frame=0,this.totalDelta=0,this.next=this.next.bind(this),this.timeout=setTimeout(this.next,u)}return Object(f.a)(e,[{key:"next",value:function(){if(this._frame++,this.callback(),!this.isStopped){var e=this.now()-(this.start+this._frame*this.idealDelta);this.totalDelta+=Math.abs(e),this.timeout=setTimeout(this.next,Math.max(this.idealDelta-e,0))}}},{key:"stop",value:function(){clearTimeout(this.timeout),this.isStopped=!0}},{key:"frame",get:function(){return this._frame}},{key:"averageDelta",get:function(){return this.totalDelta/this._frame}}]),e}();function R(e){13!==e.keyCode&&27!==e.keyCode||(e.preventDefault(),document.documentElement.focus())}var I,z,_=function(e){var t=Object(i.useState)(!1),n=Object(u.a)(t,2),a=n[0],o=n[1];return r.a.createElement(r.a.Fragment,null,r.a.createElement("label",{htmlFor:e.id},e.label,":")," ",r.a.createElement("input",{type:"number",pattern:"\\d*",value:a?"":e.value,min:e.min,max:e.max,onChange:function(t){t.target.value?(o(!1),e.onChange(function(e,t,n,i){var r=parseInt(e);return isNaN(r)?i:g(r,t,n)}(t.target.value,e.min,e.max,e.value))):o(!0)},onBlur:function(){a&&o(!1)},onKeyDown:R}))},L=n(14),A=function(e){var t=e.width,n=e.height,i=e.style,a=Object(L.a)(e,["width","height","style"]);return r.a.createElement("div",Object.assign({style:Object(c.a)({},i,{height:0,paddingTop:"".concat(n/t*100,"%")})},a))},M=(n(23),function(e){var t=e.player,n=e.sim;return r.a.createElement("div",{className:"Player-viz Player-number-".concat(t.number),title:"Player ".concat(t.number),style:{width:"".concat(t.size.x/n.size.x*100,"%"),top:"".concat(t.position.y/n.size.y*100,"%"),left:"".concat(t.position.x/n.size.x*100,"%")}},r.a.createElement(A,{width:t.size.x,height:t.size.y}))}),F=function(e){var t=e.sim;return r.a.createElement(A,{className:"Sim-viz",width:t.size.x,height:t.size.y},t.players.map((function(e){return r.a.createElement(M,{key:e.number,player:e,sim:t})})))},q={x:5,y:5},V={x:100,y:100},U={players:[{number:1,position:p,velocity:p,size:q},{number:2,position:(I=V,z=q,y(I,v(z,-1))),velocity:p,size:q}],size:V,time:0},B=function(){var e,t,n=Object(i.useState)(10),a=Object(u.a)(n,2),o=a[0],s=a[1],c=Object(i.useState)(3),l=Object(u.a)(c,2),m=l[0],h=l[1],d=Object(i.useState)(6),f=Object(u.a)(d,2),p=f[0],y=f[1],b=Object(i.useState)(60),w=Object(u.a)(b,2),g=w[0],E=w[1],O=Object(i.useRef)(new k(U,{inputTickDelay:m,networkTickDelay:p})).current,T=Object(i.useState)(O.runners[0].currentState),j=Object(u.a)(T,2),S=j[0],x=j[1],C=Object(i.useState)(O.runners[1].currentState),P=Object(u.a)(C,2),R=P[0],I=P[1],z=1e3/g,L=Object(i.useCallback)((function(e){return O.setPlayerVelocity(0,v(e,.1*o))}),[O,o]),A=Object(i.useCallback)((function(e){return O.setPlayerVelocity(1,v(e,.1*o))}),[O,o]),M=Object(i.useCallback)((function(){O.tick(),x(O.runners[0].currentState),I(O.runners[1].currentState)}),[O]);return Object(i.useEffect)((function(){return O.setInputTickDelay(m)}),[m,O]),Object(i.useEffect)((function(){return O.setNetworkTickDelay(p)}),[p,O]),e=M,t=g,Object(i.useEffect)((function(){var n=new N(t,e,(function(){return performance.now()}));return function(){return n.stop()}}),[t,e]),r.a.createElement("div",{className:"Testbed-viewports"},r.a.createElement("div",{className:"Testbed-player-1"},r.a.createElement("h2",null,"Player 1"),r.a.createElement(F,{sim:S}),r.a.createElement(D,{up:"w",down:"s",left:"a",right:"d",onChange:L})),r.a.createElement("div",{className:"Testbed-config"},r.a.createElement("h2",null,"Configuration"),r.a.createElement("p",null,r.a.createElement(_,{id:"fps",label:"Simulation FPS",min:1,max:60,value:g,onChange:E}),r.a.createElement("span",{className:"desc"},z.toFixed(0),"ms between frames")),r.a.createElement("p",null,r.a.createElement(_,{id:"itd",label:"Input frame delay",min:0,max:100,value:m,onChange:h}),r.a.createElement("span",{className:"desc"},(z*m).toFixed(0),"ms before input affects simulation")),r.a.createElement("p",null,r.a.createElement(_,{id:"ntd",label:"Network frame delay",min:0,max:100,value:p,onChange:y}),r.a.createElement("span",{className:"desc"},(z*p).toFixed(0),"ms of simulated network lag")),r.a.createElement("p",null,r.a.createElement(_,{id:"speed",label:"Player speed",min:1,max:100,value:o,onChange:s})),r.a.createElement("p",{className:"desc"},"This is an exploration of delay and rollback-based netcode in a simulated network environment. For more details, please see the ",r.a.createElement("a",{href:"https://github.com/toolness/netcode-fun#readme",target:"_blank",rel:"noopener noreferrer"},"GitHub README"),".")),r.a.createElement("div",{className:"Testbed-player-2"},r.a.createElement("h2",null,"Player 2"),r.a.createElement(F,{sim:R}),r.a.createElement(D,{up:"arrowup",down:"arrowdown",left:"arrowleft",right:"arrowright",onChange:A})))},H=n(12),W=n(7),J=n(10),G=n(13);function K(e,t){if(void 0!==e&&null!==e){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n.value}}function $(e,t){return"number"===typeof K(e,t)}function Q(e,t){return"object"===typeof K(e,t)}var X=function(){return!0},Y={"join-room":function(e){return function(e,t){return"string"===typeof K(e,t)}(e,"room")&&$(e,"playerIndex")},ping:X,pong:function(e){return $(e,"now")},"room-joined":function(e){return $(e,"timeOrigin")&&Q(e,"simRunner")},"room-left":X,"sim-command":function(e){return Q(e,"command")}};var Z=function(e){function t(){return Object(d.a)(this,t),Object(H.a)(this,Object(W.a)(t).apply(this,arguments))}return Object(J.a)(t,e),t}(Object(G.a)(Error));function ee(e){if("string"!==typeof e)throw new Z("Expected string message but got ".concat(typeof e));var t=function(e){try{return JSON.parse(e)}catch(t){return}}(e);if(void 0===t)throw new Z("Message is not JSON: ".concat(e));var n=K(t,"type");if("string"!==typeof n||!function(e){return e in Y}(n))throw new Z("Invalid message type: ".concat(e));if(!function(e,t){return Y[t](e)}(t,n))throw new Z('Message of type "'.concat(n,'" is invalid'));return t}var te=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){return performance.now()};Object(d.a)(this,e),this.now=t,this.bestRTT=1/0,this.bestServerTime=void 0,this.bestClientTime=void 0,this._updates=0,this.bestServerTime=t(),this.bestClientTime=t()}return Object(f.a)(e,[{key:"update",value:function(e,t){this._updates+=1,e<this.bestRTT&&(this.bestRTT=e,this.bestServerTime=t+e/2,this.bestClientTime=this.now())}},{key:"serverNow",value:function(){var e=this.now()-this.bestClientTime;return this.bestServerTime+e}},{key:"fromServerTime",value:function(e){return e+(this.bestClientTime-this.bestServerTime)}},{key:"updates",get:function(){return this._updates}}]),e}(),ne=(n(24),1e3);var ie,re=3;!function(e){e[e.syncingTime=0]="syncingTime",e[e.initialized=1]="initialized"}(ie||(ie={}));var ae=function(){function e(t,n){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){var e=Object({NODE_ENV:"production",PUBLIC_URL:"."}).REACT_APP_SERVER_URL;if(e)return e;var t="http:"===window.location.protocol?"ws:":"wss:",n=parseInt(window.location.port)+1;if(isNaN(n))throw new Error("Please define the environment variable REACT_APP_SERVER_URL!");return"".concat(t,"//").concat(window.location.hostname,":").concat(n,"/")}();Object(d.a)(this,e),this.room=t,this.playerIndex=n,this.url=r,this.ws=void 0,this.pingTimeout=null,this.pingStart=0,this.roundTripTime=null,this.state=ie.syncingTime,this.timeSync=new te,this.simRunner=null,this.fpsTimer=null,this.onSim=void 0,this.onOpen=void 0,this.onClose=void 0,this.onPing=void 0,this.ping=function(){i.pingStart=performance.now(),i.sendMessage({type:"ping"})},this.handleOpen=function(){i.ping(),i.onOpen&&i.onOpen()},this.handleMessage=function(e){var t=ee(e.data);switch(t.type){case"pong":return i.roundTripTime=performance.now()-i.pingStart,void(i.state===ie.syncingTime?(i.timeSync.update(i.roundTripTime,t.now),i.ping(),i.timeSync.updates>=re&&(i.state=ie.initialized,i.sendMessage({type:"join-room",room:i.room,playerIndex:i.playerIndex}))):i.onPing&&(i.onPing(i.roundTripTime),i.pingTimeout=window.setTimeout(i.ping,ne)));case"room-joined":return i.simRunner=S.deserialize(t.simRunner),i.fpsTimer=new N(t.fps,i.handleTick.bind(i),(function(){return performance.now()}),i.timeSync.fromServerTime(t.timeOrigin)),void(i.onSim&&i.onSim(i.simRunner.currentState));case"room-left":return console.log("Client left the room."),void i.ws.close();case"sim-command":return void(i.simRunner?i.simRunner.queuedCommands.push(t.command):console.log("Received sim command but no sim runner is set!"));default:return void console.log("Don't know what to do with message type \"".concat(t.type,'"'))}},this.handleClose=function(){i.onClose&&i.onClose(),i.shutdown()},this.ws=new WebSocket(r),this.ws.onopen=this.handleOpen,this.ws.onmessage=this.handleMessage,this.ws.onclose=this.handleClose}return Object(f.a)(e,[{key:"sendMessage",value:function(e){var t;this.ws.send((t=e,JSON.stringify(t)))}},{key:"handleTick",value:function(){this.simRunner&&(this.simRunner.tick(),this.onSim&&this.onSim(this.simRunner.currentState))}},{key:"movePlayer",value:function(e){if(this.simRunner){var t=this.simRunner.setPlayerVelocity(this.playerIndex,e);this.sendMessage({type:"sim-command",command:t})}}},{key:"shutdown",value:function(){var e;null!==this.pingTimeout&&(window.clearTimeout(this.pingTimeout),this.pingTimeout=null),null===(e=this.fpsTimer)||void 0===e||e.stop(),this.fpsTimer=null,this.onOpen=void 0,this.onClose=void 0,this.onPing=void 0,this.ws.close()}},{key:"isConnected",get:function(){return this.ws.readyState===WebSocket.OPEN}}]),e}(),oe=function(e){var t=Object(i.useState)("connecting"),n=Object(u.a)(t,2),a=n[0],o=n[1],s=Object(i.useState)(null),c=Object(u.a)(s,2),l=c[0],m=c[1],h=Object(i.useState)(null),d=Object(u.a)(h,2),f=d[0],p=d[1],y=Object(i.useRef)(null);Object(i.useEffect)((function(){var t=new ae(e.room,e.playerIndex);return t.onOpen=function(){return o("connected")},t.onClose=function(){o("disconnected"),p(null)},t.onPing=function(e){return m(e)},t.onSim=p,y.current=t,function(){return t.shutdown()}}),[e.room,e.playerIndex]);var v=Object(i.useCallback)((function(e){y.current&&y.current.movePlayer(e)}),[]);return r.a.createElement("div",{className:"Sim"},r.a.createElement("p",null,"Connection state: ",a),f&&r.a.createElement(r.a.Fragment,null,r.a.createElement(F,{sim:f}),r.a.createElement(D,{up:"w",down:"s",left:"a",right:"d",onChange:v})),null!==l&&r.a.createElement("p",null,"Ping: ",l.toFixed(0)," ms"))},se=function(e){var t=new URLSearchParams(e.search||window.location.search),n=t.get("room"),i=parseInt(t.get("p")||"0");return r.a.createElement(m,null,r.a.createElement("div",{className:"App"},n&&!isNaN(i)?r.a.createElement(oe,{room:n,playerIndex:i}):r.a.createElement(B,null)))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(r.a.createElement(se,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}));var ce=window.navigator.userAgent;(ce.match(/iPad/i)||ce.match(/iPhone/i))&&document.documentElement.classList.add("disable-ios-text-selection")}],[[15,1,2]]]);
//# sourceMappingURL=main.0b07e8ad.chunk.js.map